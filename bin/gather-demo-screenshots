#!/usr/bin/env node
// Based on https://github.com/admc/wd/blob/v1.1.1/examples/promise/chrome.js
// Load in our dependencies
var functionToString = require('function-to-string');
var wd = require('wd');

// Add custom methods for screenshots
// https://github.com/admc/wd/tree/v1.1.1#adding-custom-methods
wd.addPromiseChainMethod('screenshotLarge', function screenshotLargeFn (filepath) {
  // Resize browser and screenshot
  return this
    // https://github.com/admc/wd/blob/v1.1.1/lib/commands.js#L569-L577
    .setWindowSize(1024, 768)
    // https://github.com/admc/wd/blob/v1.1.1/lib/commands.js#L1108-L1114
    .saveScreenshot(filepath);
});
wd.addPromiseChainMethod('screenshotMedium', function screenshotLargeFn (filepath) {
  return this.setWindowSize(480, 800).saveScreenshot(filepath);
});
wd.addPromiseChainMethod('screenshotSmall', function screenshotLargeFn (filepath) {
  return this.setWindowSize(360, 480).saveScreenshot(filepath);
});

// Create our browser
// DEV: Typically we would prefer callbacks over promises but chaining is quite nice
var browser = wd.promiseChainRemote();

// Add logging for feedback
browser.on('status', function handleStatus (info) {
  console.log('Status:', info.trim());
});
browser.on('command', function handleCommand (eventType, command, response) {
  // If this is a response, ignore it
  if (eventType === 'RESPONSE') {
    return;
  }
  console.log('Command:', eventType, command, (response || ''));
});

// Gather our screenshots
browser
  .init({browserName: 'chrome'})
  .get('http://getbootstrap.com/')
  .execute(functionToString(function cleanPage () {
    // Remove "Bootstrap 4" banner
    var bannerEl = document.querySelector('.v4-tease');
    if (!bannerEl) { throw new Error('Unable to find ".v4-tease"'); }
    bannerEl.parentNode.removeChild(bannerEl);

    // Remove ads
    var adEl = document.querySelector('#carbonads-container');
    if (!adEl) { throw new Error('Unable to find "#carbonads-container"'); }
    adEl.parentNode.removeChild(adEl);
  }).body)
  .screenshotLarge('root.large.png')
  .screenshotMedium('root.medium.png')
  .screenshotSmall('root.small.png')
  .fin(function handleFin () { return browser.quit(); })
  .done();
