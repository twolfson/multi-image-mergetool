#!/usr/bin/env node
// Based on https://github.com/admc/wd/blob/v1.1.1/examples/promise/chrome.js
// Load in our dependencies
var async = require('async');
var functionToString = require('function-to-string');
var rimraf = require('rimraf');
var mkdirp = require('mkdirp');
var wd = require('wd');

// Reset our demo directory
var demoDir = __dirname + '/../demo';
rimraf.sync(demoDir);
mkdirp.sync(demoDir + '/ref');
mkdirp.sync(demoDir + '/current');

// Add custom methods for screenshots
// https://github.com/admc/wd/tree/v1.1.1#adding-custom-methods
wd.addPromiseChainMethod('screenshotLarge', function screenshotLargeFn (filepath) {
  // Resize browser and screenshot
  return this
    // https://github.com/admc/wd/blob/v1.1.1/lib/commands.js#L569-L577
    .setWindowSize(1024, 768)
    // Give our browser time to handle resize, it caused some weird UI issues
    // TODO: Consider adding signature tracking to screenshots to prevent undesired screenshot issues
    //   On screenshot generation for demo, assert final images match expected signatures. Includes after diffs
    // TODO: Add a "new" screenshot?
    .then(function () { return new Promise(function (resolve) { setTimeout(resolve, 100); }); })
    // https://github.com/admc/wd/blob/v1.1.1/lib/commands.js#L1108-L1114
    .saveScreenshot(filepath);
});
wd.addPromiseChainMethod('screenshotSmall', function screenshotLargeFn (filepath) {
  return this.setWindowSize(360, 480).saveScreenshot(filepath);
});

// Define a function to gather screenshots
function gatherScreenshots(name, urlPath, cb) {
  // Create our browser
  // DEV: Typically we would prefer callbacks over promises but chaining is quite nice
  var browser = wd.promiseChainRemote();

  // Add logging for feedback
  browser.on('status', function handleStatus (info) {
    console.log('Status (' + name + '):', info.trim());
  });
  browser.on('command', function handleCommand (eventType, command, response) {
    // If this is a response, ignore it
    if (eventType === 'RESPONSE') {
      return;
    }
    console.log('Command (' + name + '):', eventType, command, (response || ''));
  });

  // Perform our screenshot collection
  browser
    .init({browserName: 'chrome'})
    .get('http://getbootstrap.com' + urlPath)
    .execute(functionToString(function cleanPage () {
      // Remove "Bootstrap 4" banner
      var bannerEl = document.querySelector('.v4-tease');
      if (!bannerEl) { throw new Error('Unable to find ".v4-tease"'); }
      bannerEl.parentNode.removeChild(bannerEl);

      // Remove ads
      var adEl = document.querySelector('#carbonads-container');
      if (!adEl) { throw new Error('Unable to find "#carbonads-container"'); }
      adEl.parentNode.removeChild(adEl);
    }).body)
    .screenshotLarge(demoDir + '/ref/' + name + '.large.png')
    .screenshotSmall(demoDir + '/ref/' + name + '.small.png')
    .execute(functionToString(function alterPage () {
      // Alter nav bar to demonstrate changes
      var componentsLinkEl = document.querySelector('#bs-navbar a[href="../components/"]');
      if (!componentsLinkEl) { throw new Error('Unable to find "#bs-navbar a[href="../components/"]"'); }
      componentsLinkEl.textContent = 'Widgets';
      var expoLinkEl = document.querySelector('#bs-navbar a[href="http://expo.getbootstrap.com"]');
      if (!expoLinkEl) { throw new Error('Unable to find "#bs-navbar a[href="http://expo.getbootstrap.com"]"'); }
      // DEV: Remove the `li` containing our expo link
      var expoLiEl = expoLinkEl.parentNode;
      if (expoLiEl.tagName !== 'LI') { throw new Error('`expoLinkEl.parentNode` was not an `<li>` as expected'); }
      expoLiEl.parentNode.removeChild(expoLiEl);
    }).body)
    .screenshotLarge(demoDir + '/current/' + name + '.large.png')
    .screenshotSmall(demoDir + '/current/' + name + '.small.png')
    .fin(function handleFin () { return browser.quit(); })
    .done(function handleDone () { cb(); });
}

// Gather our screenshots
async.parallel([
  function gatherRootScreenshots (cb) {
    gatherScreenshots('root', '/', cb);
  },
  function gatherGettingStartedScreenshots (cb) {
    gatherScreenshots('getting-started', '/getting-started/', cb);
  }
], function handleError (err) {
  // If there was an error, throw it
  if (err) {
    throw err;
  }
});
